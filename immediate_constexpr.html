<html><head><meta http-equiv="Content-Type" content="text/html; charset=windows-1252"></head>

<style type="text/css">
  ins { text-decoration:none; font-weight:bold; background-color:#A0FFA0 }
  del { text-decoration:line-through; background-color:#FFA0A0 }
  xins { font-weight: inherit; color: #2020ff }
  tab { padding-left: 4em }
</style>
<body>
<p align=right><b>P0xxxR0, 2018-04-26</b>
<br/>EWG
</p>

<p align=right>
<br/>Andrew Sutton (andrew.n.sutton@gmail.com)  
<br/>Daveed Vandevoorde (daveed@edg.com)
</p>

<h1>constexpr!</h1>

<h3>Introduction and motivation</h3>

<h4>Functions</h4>
<p>
The <tt>constexpr</tt> specifier applied to a function or member function
indicates that a call to that function might be valid in a context requiring
a constant-expression.  It does not <i>require</i> that every such
call be a constant-expression.  Sometimes, however, we want to express
that a function should <i>always</i> produce a constant when called (directly
or indirectly), and a non-constant result should produce an error.  Such a
function is called an <i>immediate</i> function.  We propose the <i>decl-specifier</i>
<tt>constexpr!</tt> for that purpose:

<pre><code class="language-c++">constexpr! int sqr(int n) {
  return n*n;
}
constexpr int r = sqr(100);  // Okay.
int x = 100;
int r2 = sqr(x);  // Error: Call does not produce a constant.
</code></pre>
</p>
<p>
There is one exception to the rule that a call to a <tt>constexpr!</tt>
function must be a constant-expression: If the call appears directly in another
<tt>constexpr!</tt>, it need not be a constant-expression at that point (since
a call to the enclosing function would ultimately have to produce a core constant
expression, we do not have to worry about ever having to evaluate that nested
call at run time).  This permits composition of <tt>constexpr!</tt> functions:

<pre><code class="language-c++">constexpr! int sqrsqr(int n) {
  return sqr(sqr(n)); // Not a constant-expression at this  point,
}                     // but that's okay.

constexpr int dblsqr(int n) {
  return 2*sqr(n); // Error: Enclosing function is not
}                  // constexpr!.
</code></pre>
</p>
<p>
Finally, a glvalue cannot contain a pointer or reference to a <tt>constexpr!</tt>
function:

<pre><code class="language-c++">using Int2Int = int(int);
constexpr Int2Int* indirect() {
  Int2Int *pf = (Int2Int*)sqr;  // Error.
}
</code></pre>
</p>
<p>
One consequence of this specification is that an immediate function never needs
to be seen by a back end.  (Its address can be taken, but that address cannot
leak into the run time.)  That means that immediate functions are an alternative
to many function-style macros.
</p>

<h4>Variables</h4>
<p>
Given that <tt>constexpr!</tt> functions are a useful alternative to function-style
macros, it is natural to wonder whether we could make <tt>constexpr!</tt>
<i>variables</i> a useful alternative to non-function-style macros.  We answer in
the affirmative by specifying that a <tt>constexpr!</tt> variable is always
immediately converted to a prvalue when designated by an <i>id-expression</i>;
we call such variables <i>immediate</i> variables.
For example:
<pre><code class="language-c++">constexpr! int RN = 42;
int LN = 42;

int f(int const&);

int r1 = f(LN);  // Direct reference binding.
int r2 = f(RN);  // Not a direct binding (temporary created).
</code></pre>
</p>

<p>
As with immediate functions, an immediate variable need never be seen by a back end.
</p>

<h2>Wording changes (FIXME: This is from another paper)</h2>

<p>Add to the grammar of [dcl.spec] paragraph 1:</p>  
<blockquote style="padding-left: 30px;">
	<i>decl-specifier</i>:<br/>
	<tab><i>storage-class-specifier</i><br/>
	<tab><i>defining-type-specifier</i><br/>
	<tab><i>function-specifier</i><br/>
	<tab><tt>friend</tt><br/>
	<tab><tt>typedef</tt><br/>
	<tab><tt>constexpr</tt><br/>
	<tab><ins><tt>constexpr!</tt></ins><br/>
	<tab><tt>inline</tt>
</blockquote>

<p>Update [dcl.constexpr] paragraph 1 as follows:

<blockquote style="padding-left: 30px;">
	The <tt>constexpr</tt> <ins>or <tt>constexpr!</tt> </ins>specifier shall be applied only to the
	definition of a variable or variable template or the declaration of a function or function template.
	A function or static data member declared with the <tt>constexpr</tt> <ins>or
	<tt>constexpr!</tt> </ins>specifier is implicitly an inline function or variable (10.1.6). If any
	declaration of a function or function template has a <tt>constexpr</tt> <ins> or
	<tt>constexpr!</tt> </ins>specifier, then all its declarations shall contain <del>the constexpr</del>
	<ins>that same</ins> specifier. [ Note: An explicit specialization can differ from the template
	declaration with respect to the <tt>constexpr</tt> <ins>or <tt>constexpr!</tt> </ins>specifier.
	— end note ] [ Note: Function parameters cannot be declared <tt>constexpr</tt><ins> or
	<tt>constexpr!</tt></ins>. — end note ]
</blockquote>

<p>Update [dcl.constexpr] paragraph 2 as follows:
<blockquote style="padding-left: 30px;">
	A <tt>constexpr</tt> <ins>or <tt>constexpr!</tt> </ins>specifier used in the declaration of a function
	that is not a constructor declares that function to be a <i>constexpr function</i>. Similarly, a
	<tt>constexpr</tt> <ins>or <tt>constexpr!</tt> </ins>specifier used in a constructor declaration
	declares that constructor to be a <i>constexpr constructor</i>.<ins>  A function or constructor declared
	with the <tt>constexpr!</tt> specifier is called an <i>immediate function</i>.</ins>
</blockquote>

<p>Update [dcl.constexpr] paragraph 8 as follows:
<blockquote style="padding-left: 30px;">
	The <tt>constexpr</tt> <ins>or <tt>constexpr!</tt> </ins>specifier has no effect on the type of a
	constexpr function or a constexpr constructor.
</blockquote>

<p>Update [dcl.constexpr] paragraph 9 as follows:
<blockquote style="padding-left: 30px;">
	A <tt>constexpr</tt> <ins>or <tt>constexpr!</tt> </ins>specifier used in an object declaration
	declares the object as const. Such an object shall have literal type and shall be initialized.
	<ins>A <i>constexpr variable</i> is a variable declared with a <tt>constexpr</tt> or
	<tt>constexpr!</tt> specifier.  An <i>immediate variable</i> is a variable declared with a
	<tt>constexpr!</tt> specifier.</ins>
	In any <del><tt>constexpr</tt></del><ins>constexpr</ins> variable declaration, the
	full-expression of the initialization shall be a constant expression (8.6).
</blockquote>
	
</body></html>
